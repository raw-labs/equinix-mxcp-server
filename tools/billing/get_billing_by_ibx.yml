mxcp: 1
tool:
  name: get_billing_by_ibx
  description: |
    Get detailed billing lines for a specific IBX location.
    Use this to analyze charges at DB1, DB2, or DB3 Dublin data centers.
  tags:
    - billing
    - detail
  annotations:
    title: "Billing by IBX"
    readOnlyHint: true
    destructiveHint: false
    idempotentHint: true
    openWorldHint: false
  parameters:
    - name: ibx
      type: string
      description: "IBX site code to filter."
      enum: ["DB1", "DB2", "DB3"]
      examples: ["DB1", "DB2"]
    - name: product_category
      type: string
      description: "Optional product category filter. Leave empty to include all categories."
      default: ""
      enum: ["", "Power", "Interconnection", "Services", "Space"]
      examples: ["Power", "Space"]
    - name: charge_type
      type: string
      description: "Optional charge type filter. Leave empty to include all charge types."
      default: ""
      enum: ["", "RC", "NRC", "Usage", "Reseller Discount"]
      examples: ["RC", "NRC"]
  return:
    type: array
    description: "Billing line items for the specified IBX location."
    items:
      type: object
      description: "A single billing transaction line."
      properties:
        trx_number:
          type: string
          description: "Invoice transaction number."
        trx_date:
          type: string
          format: date
          description: "Transaction date (YYYY-MM-DD)."
        product_category:
          type: string
          description: "Product category (Power, Interconnection, Services, Space)."
        charge_type:
          type: string
          description: "Charge type label (RC, NRC, Usage, Reseller Discount)."
        ibx:
          type: string
          description: "IBX data center location code (matches the filter parameter)."
        description:
          type: string
          description: "Line item description from the invoice."
        quantity:
          type: number
          description: "Billed quantity."
        unit_price:
          type: number
          description: "Price per unit."
        line_amount:
          type: number
          description: "Net line amount before GST."
        total_amount:
          type: number
          description: "Total amount including GST."
  source:
    code: |
      SELECT
        trx_number,
        trx_date,
        product_category,
        charge_type,
        ibx,
        description,
        quantity,
        unit_price,
        line_amount,
        total_amount
      FROM load_billing_data
      WHERE ibx = $ibx
        AND ($product_category = '' OR product_category = $product_category)
        AND ($charge_type = '' OR charge_type = $charge_type)
      ORDER BY trx_date, trx_number
  tests:
    - name: get_db2_billing_lines
      description: "Returns all DB2 lines."
      arguments:
        - key: ibx
          value: "DB2"
      result_length: 619
    - name: db3_contains_power
      description: "DB3 results include Power lines."
      arguments:
        - key: ibx
          value: "DB3"
      result_contains_item:
        ibx: "DB3"
        product_category: "Power"
