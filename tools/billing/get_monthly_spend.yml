mxcp: 1
tool:
  name: get_monthly_spend
  description: |
    Return monthly billing spend trend by product category.
    Each record includes a year-month bucket, summed total amount, and line count.
    Use this for spend trend analysis over time.
  tags:
    - billing
    - trend
  annotations:
    title: "Monthly Spend Trend"
    readOnlyHint: true
    destructiveHint: false
    idempotentHint: true
    openWorldHint: false
  parameters: []
  return:
    type: array
    description: "Monthly spend rows grouped by month and product category."
    items:
      type: object
      description: "Aggregated spend for one month-category combination."
      properties:
        month:
          type: string
          description: "Year-month bucket (YYYY-MM format)."
        product_category:
          type: string
          description: "Billing product category."
        total_amount:
          type: number
          description: "Sum of total amounts including GST for this month and category."
        line_count:
          type: integer
          description: "Number of billing line items in this group."
  source:
    code: |
      SELECT
        STRFTIME(trx_date, '%Y-%m') AS month,
        product_category,
        ROUND(SUM(total_amount), 2) AS total_amount,
        CAST(COUNT(*) AS INTEGER) AS line_count
      FROM load_billing_data
      GROUP BY 1, 2
      ORDER BY month, product_category
  tests:
    - name: monthly_spend_group_count
      description: "Returns all monthly product-category groups."
      arguments: []
      result_length: 29
    - name: monthly_spend_contains_space_aug_2025
      description: "Includes Space billing for August 2025."
      arguments: []
      result_contains_item:
        month: "2025-08"
        product_category: "Space"
        line_count: 20
